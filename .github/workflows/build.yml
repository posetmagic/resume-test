name: Build and Deploy CV
on:
  push:
    branches: ["main"]
permissions:
  contents: read
  pages: write
  id-token: write
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DIR: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Find and build all .tex files
        run: |
          # Find all .tex files and build each one
          find ${{ env.DIR }} -name "*.tex" -print0 | while IFS= read -r -d '' texfile; do
            echo "Building $texfile"
            base_dir=$(dirname "$texfile")
            base_name=$(basename "$texfile" .tex)
            mkdir -p "$base_dir/_site"
            # Using the LaTeX Action to compile the .tex file
            latexmk -pdf -cd "$texfile" -output-directory="$base_dir/_site"
          done
        shell: bash

      - name: Move PDFs to _site preserving structure
        run: |
          mkdir -p _site
          find ${{ env.DIR }} -name "*.pdf" -exec bash -c '
            pdf_path="{}"
            relative_path="${pdf_path#${{ env.DIR }}/}"
            mkdir -p "_site/$(dirname "$relative_path")"
            mv "$pdf_path" "_site/$relative_path"
          ' \;

      - name: Copy index.html and CNAME
        run: |
          cp index.html _site/ || true
          cp CNAME _site/ || true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
